/*2013-08-15-hongru*/!function(a){var b=a.Class(function(b){var c={numIterations:10,kTimeStep:1/60,kGravity:25,kFriction:.3};a.mix(this,a.mix(c,b||{})),this.objects=[],this.contactsI=0,this.contacts=[],this.mostSeparated=[0,0,0,0,0],this.mostPenetrating=[0,0,0,0,0]}).methods({addObject:function(b){!b instanceof a.Polygon&&console&&console.warn("Not intance of Poco.Polygon"),b.world=this,this.objects.push(b)},step:function(){this.collide(),this.solve(),this.integrate(),this.generateMotionAABB()},collide:function(){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r;this.contactsI=0;for(var s=this.objects,t=0,u=s.length;u-1>t;t++)for(var v=s[t],w=t+1;u>w;w++){var x=s[w];if(0!=v.invMass||0!=x.invMass){var y=v.motionBounds,z=x.motionBounds;Math.abs(z[0]-y[0])-(y[2]+z[2])<0&&Math.abs(z[1]-y[1])-(y[3]+z[3])<0&&(this.mostSeparated=[1e9,-1,-1,0,1e9],this.mostPenetrating=[-1e9,-1,-1,0,1e9],v.featurePairJudgement(x,2),x.featurePairJudgement(v,1),this.mostSeparated[0]>0&&0!=this.mostSeparated[3]?(b=this.mostSeparated[2],c=this.mostSeparated[1],d=this.mostSeparated[3]):this.mostPenetrating[0]<=0&&(b=this.mostPenetrating[2],c=this.mostPenetrating[1],d=this.mostPenetrating[3]),1==d?(e=v,f=x):(e=x,f=v),r=f.worldSpaceNormals[b],g=[r[0],r[1]],l=e.worldSpacePoints[(c-1+e.vCount)%e.vCount],m=e.worldSpacePoints[c],n=e.worldSpacePoints[(c+1)%e.vCount],o=[-(m[1]-l[1]),m[0]-l[0]],q=Math.sqrt(o[0]*o[0]+o[1]*o[1]),o[0]/=q,o[1]/=q,p=[-(n[1]-m[1]),n[0]-m[0]],q=Math.sqrt(p[0]*p[0]+p[1]*p[1]),p[0]/=q,p[1]/=q,o[0]*g[0]+o[1]*g[1]<p[0]*g[0]+p[1]*g[1]?(h=l,i=m):(h=m,i=n),j=f.worldSpacePoints[b],k=f.worldSpacePoints[(b+1)%f.vCount],1===d?(v.projectPointOntoEdge(j,h,i,0),v.projectPointOntoEdge(k,h,i,1),x.projectPointOntoEdge(i,j,k,0),x.projectPointOntoEdge(h,j,k,1),g[0]=-g[0],g[1]=-g[1]):(v.projectPointOntoEdge(i,j,k,0),v.projectPointOntoEdge(h,j,k,1),x.projectPointOntoEdge(j,h,i,0),x.projectPointOntoEdge(k,h,i,1)),this.contacts[this.contactsI]||(this.contacts[this.contactsI]=new a.Contact),this.contacts[this.contactsI++].set(v,x,0,g),this.contacts[this.contactsI]||(this.contacts[this.contactsI]=new a.Contact),this.contacts[this.contactsI++].set(v,x,1,g))}}},solve:function(){for(var a=0;a<this.numIterations;a++)for(var b=0;b<this.contactsI;b++){var c=this.contacts[b],d=c.a,e=c.b,f=c.ra,g=c.rb,h=c.normal,i=[e.vel[0]+g[0]*e.angularVel-(d.vel[0]+f[0]*d.angularVel),e.vel[1]+g[1]*e.angularVel-(d.vel[1]+f[1]*d.angularVel)],j=i[0]*h[0]+i[1]*h[1]+c.dist/this.kTimeStep;if(0>j){var k=j*c.invDenom,l=Math.min(k+c.impulseN,0),m=l-c.impulseN,n=h[0]*m,o=h[1]*m;d.vel[0]+=n*d.invMass,d.vel[1]+=o*d.invMass,e.vel[0]-=n*e.invMass,e.vel[1]-=o*e.invMass,d.angularVel+=(n*f[0]+o*f[1])*d.invI,e.angularVel-=(n*g[0]+o*g[1])*e.invI,c.impulseN=l;var p=Math.abs(c.impulseN)*this.kFriction,q=i[0]*-h[1]+i[1]*h[0];l=Math.min(Math.max(q*c.invDenomTan+c.impulseT,-p),p);var m=l-c.impulseT;n=-h[1]*m,o=h[0]*m,d.vel[0]+=n*d.invMass,d.vel[1]+=o*d.invMass,e.vel[0]-=n*e.invMass,e.vel[1]-=o*e.invMass,d.angularVel+=(n*f[0]+o*f[1])*d.invI,e.angularVel-=(n*g[0]+o*g[1])*e.invI,c.impulseT=l}}},integrate:function(){for(var a,b=this.objects,c=this.kGravity,d=this.kTimeStep,e=0;a=b[e++];){a.drag?(a.vel[0]=10*(pointer.X-a.pos[0]),a.vel[1]=10*(pointer.Y-a.pos[1])):(a.vel[0]*=.98,a.invMass>0&&(a.vel[1]+=c)),a.pos=[a.pos[0]+a.vel[0]*d,a.pos[1]+a.vel[1]*d],a.angle+=a.angularVel*d;var f=Math.cos(a.angle),g=Math.sin(a.angle);a.matrix=[f,g,-g,f,a.pos[0],a.pos[1]];var h=a.angle+a.angularVel*d,f=Math.cos(h),g=Math.sin(h);a.matrixNextFrame=[f,g,-g,f,a.pos[0]+a.vel[0]*d,a.pos[1]+a.vel[1]*d]}},generateMotionAABB:function(){for(var a,b=this.objects,c=0;a=b[c++];){for(var d,e=[1e6,1e6],f=[-1e6,-1e6],g=a.matrix,h=a.matrixNextFrame,i=0;i<a.vCount;i++)for(var j=a.points[i],k=a.normals[i],l=0;2>l;l++)d=g[l]*j[0]+g[2+l]*j[1]+g[4+l],a.worldSpacePoints[i][l]=d,d<e[l]&&(e[l]=d),d>f[l]&&(f[l]=d),d=h[l]*j[0]+h[2+l]*j[1]+h[4+l],d<e[l]&&(e[l]=d),d>f[l]&&(f[l]=d),d=g[l]*k[0]+g[2+l]*k[1],a.worldSpaceNormals[i][l]=d;a.motionBounds=[.5*(e[0]+f[0]),.5*(e[1]+f[1]),.5*(f[0]-e[0]),.5*(f[1]-e[1])]}}});a.World=b}(Poco);